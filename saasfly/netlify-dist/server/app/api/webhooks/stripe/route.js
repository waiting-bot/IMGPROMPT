"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},78215:(e,_,t)=>{t.r(_),t.d(_,{originalPathname:()=>C,patchFetch:()=>u,requestAsyncStorage:()=>R,routeModule:()=>S,serverHooks:()=>c,staticGenerationAsyncStorage:()=>a});var r={};t.r(r),t.d(r,{GET:()=>p,POST:()=>p});var E=t(63036),i=t(5736),s=t(15262),o=t(60942),I=t(53116),n=t(3517),T=t(2766);let P=(0,n.D)({server:{NEXTAUTH_URL:T.z.string().url().optional(),NEXTAUTH_SECRET:T.z.string().min(1),GITHUB_CLIENT_ID:T.z.string().min(1),GITHUB_CLIENT_SECRET:T.z.string().min(1),STRIPE_API_KEY:T.z.string().min(1),STRIPE_WEBHOOK_SECRET:T.z.string().min(1)},client:{NEXT_PUBLIC_APP_URL:T.z.string().min(1),NEXT_PUBLIC_STRIPE_PRO_PRODUCT_ID:T.z.string().optional(),NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID:T.z.string().optional(),NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID:T.z.string().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_PRODUCT_ID:T.z.string().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PRICE_ID:T.z.string().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PRICE_ID:T.z.string().optional(),NEXT_PUBLIC_POSTHOG_KEY:T.z.string().optional(),NEXT_PUBLIC_POSTHOG_HOST:T.z.string().optional()},runtimeEnv:{NEXTAUTH_URL:process.env.NEXTAUTH_URL,NEXTAUTH_SECRET:process.env.NEXTAUTH_SECRET,GITHUB_CLIENT_ID:process.env.GITHUB_CLIENT_ID,GITHUB_CLIENT_SECRET:process.env.GITHUB_CLIENT_SECRET,STRIPE_API_KEY:process.env.STRIPE_API_KEY,STRIPE_WEBHOOK_SECRET:process.env.STRIPE_WEBHOOK_SECRET,NEXT_PUBLIC_APP_URL:"http://localhost:3000",NEXT_PUBLIC_STRIPE_PRO_PRODUCT_ID:"prod_",NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_BUSINESS_PRODUCT_ID:"prod_",NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PRICE_ID:"price_",NEXT_PUBLIC_POSTHOG_KEY:" ",NEXT_PUBLIC_POSTHOG_HOST:"https://app.posthog.com"}}),p=async e=>{let _=await e.text(),t=e.headers.get("Stripe-Signature");try{let e=I.A.webhooks.constructEvent(_,t,P.STRIPE_WEBHOOK_SECRET);return await (0,I.Z)(e),console.log("✅ Handled Stripe Event",e.type),o.NextResponse.json({received:!0},{status:200})}catch(_){let e=_ instanceof Error?_.message:"Unknown error";return console.log(`❌ Error when handling Stripe Event: ${e}`),o.NextResponse.json({error:e},{status:400})}},S=new E.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/waiting/Documents/VS/img prommpt/saasfly/apps/nextjs/src/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:R,staticGenerationAsyncStorage:a,serverHooks:c}=S,C="/api/webhooks/stripe/route";function u(){return(0,s.patchFetch)({serverHooks:c,staticGenerationAsyncStorage:a})}},26310:(e,_,t)=>{t.d(_,{Th:()=>s,db:()=>o});let r=require("pg");var E=t(53411),i=t(14853);let s={FREE:"FREE",PRO:"PRO",BUSINESS:"BUSINESS"},o=new E.$2({dialect:new i.o({pool:new r.Pool({connectionString:process.env.POSTGRES_URL})})})},53116:(e,_,t)=>{t.d(_,{Z:()=>n,A:()=>T});var r=t(40609),E=t(3517),i=t(2766);let s=(0,E.D)({shared:{},server:{STRIPE_API_KEY:i.Z_()},client:{NEXT_PUBLIC_STRIPE_PRO_PRODUCT_ID:i.Z_().optional(),NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID:i.Z_().optional(),NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID:i.Z_().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_PRODUCT_ID:i.Z_().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PRICE_ID:i.Z_().optional(),NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PRICE_ID:i.Z_().optional()},experimental__runtimeEnv:{NEXT_PUBLIC_STRIPE_PRO_PRODUCT_ID:"prod_",NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_BUSINESS_PRODUCT_ID:"prod_",NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PRICE_ID:"price_",NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PRICE_ID:"price_"},skipValidation:!!process.env.SKIP_ENV_VALIDATION||"lint"===process.env.npm_lifecycle_event});var o=t(26310);let I={[s.NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PRICE_ID]:o.Th.PRO,[s.NEXT_PUBLIC_STRIPE_PRO_YEARLY_PRICE_ID]:o.Th.PRO,[s.NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PRICE_ID]:o.Th.BUSINESS,[s.NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PRICE_ID]:o.Th.BUSINESS};async function n(e){let _=e.data.object;if("checkout.session.completed"===e.type){let e=await T.subscriptions.retrieve(_.subscription),t="string"==typeof e.customer?e.customer:e.customer.id,{userId:r}=e.metadata;if(!r)throw Error("Missing user id");let E=await o.db.selectFrom("Customer").selectAll().where("authUserId","=",r).executeTakeFirst();if(E)return await o.db.updateTable("Customer").where("id","=",E.id).set({stripeCustomerId:t,stripeSubscriptionId:e.id,stripePriceId:e.items.data[0]?.price.id}).execute()}if("invoice.payment_succeeded"===e.type){let e=await T.subscriptions.retrieve(_.subscription),t="string"==typeof e.customer?e.customer:e.customer.id,{userId:r}=e.metadata;if(!r)throw Error("Missing user id");let E=await o.db.selectFrom("Customer").selectAll().where("authUserId","=",r).executeTakeFirst();if(E){let _=e.items.data[0]?.price.id;if(!_)return;let r=_&&I[_]?I[_]:o.Th.FREE;return await o.db.updateTable("Customer").where("id","=",E.id).set({stripeCustomerId:t,stripeSubscriptionId:e.id,stripePriceId:_,stripeCurrentPeriodEnd:new Date(1e3*e.current_period_end),plan:r||o.Th.FREE}).execute()}}"customer.subscription.updated"===e.type&&console.log("event.type: ",e.type),console.log("✅ Stripe Webhook Processed")}let T=new r.h(s.STRIPE_API_KEY,{typescript:!0})}};var _=require("../../../../webpack-runtime.js");_.C(e);var t=e=>_(_.s=e),r=_.X(0,[522,600,942],()=>t(78215));module.exports=r})();